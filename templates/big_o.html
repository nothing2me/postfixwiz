<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big-O Practice - Postfix Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-gradient-to-br from-teal-50 to-cyan-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold text-teal-800 mb-2">‚ö° Big-O Practice</h1>
            <p class="text-xl text-gray-700">Master time complexity analysis</p>
            <a href="/" class="text-teal-600 hover:text-teal-800 underline mt-2 inline-block">‚Üê Back to Home</a>
        </div>

        <!-- Stats Bar -->
        <div class="max-w-4xl mx-auto mb-6">
            <div class="bg-white rounded-lg shadow-lg p-4 flex justify-around items-center">
                <div class="text-center">
                    <p class="text-sm text-gray-600">Accuracy</p>
                    <p class="text-2xl font-bold text-indigo-600" id="accuracy">0%</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-600">Correct</p>
                    <p class="text-2xl font-bold text-green-600" id="correct">0</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-600">Total</p>
                    <p class="text-2xl font-bold text-gray-600" id="total">0</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-600">Streak</p>
                    <p class="text-2xl font-bold text-orange-600" id="streak">0</p>
                </div>
            </div>
        </div>

        <!-- Main Card -->
        <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-8">
            <!-- Controls -->
            <div class="mb-6 flex flex-wrap gap-4 items-center justify-between">
                <div class="flex gap-2">
                    <label class="text-gray-700 font-semibold">Difficulty:</label>
                    <select id="difficulty" class="border-2 border-teal-300 rounded px-3 py-1">
                        <option value="easy">Easy</option>
                        <option value="medium">Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <label class="text-gray-700 font-semibold">Type:</label>
                    <select id="problem-type" class="border-2 border-teal-300 rounded px-3 py-1">
                        <option value="both">Both</option>
                        <option value="code_analysis">Code Analysis</option>
                        <option value="simplify">Simplify Expression</option>
                        <option value="match">Match Code</option>
                    </select>
                </div>
                <button 
                    onclick="generateProblem()"
                    class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded-lg transition-all"
                >
                    New Problem
                </button>
            </div>

            <!-- Problem Display -->
            <div id="problem-container" class="hidden">
                <div class="bg-gradient-to-r from-teal-50 to-cyan-50 rounded-lg p-6 mb-6">
                    <p class="text-lg font-semibold text-gray-700 mb-4" id="question-text"></p>
                    
                    <!-- Code block for code_analysis and match types -->
                    <div id="code-display" class="hidden bg-gray-900 text-gray-100 rounded-lg p-4 mb-4 font-mono text-sm overflow-x-auto">
                        <pre id="code-text"></pre>
                    </div>
                    
                    <!-- Expression display for simplify type -->
                    <div id="expression-display" class="hidden bg-white rounded-lg p-4 shadow-inner mb-4">
                        <p class="text-3xl font-mono font-bold text-teal-800 text-center" id="expression-text"></p>
                    </div>
                    
                    <!-- Multiple choice options for match type -->
                    <div id="options-display" class="hidden grid grid-cols-2 gap-3 mt-4">
                        <!-- Options will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Answer Input (for code_analysis and simplify types) -->
                <div id="answer-input-container" class="mb-6 hidden">
                    <label for="answer-input" class="block text-lg font-semibold text-gray-700 mb-2">
                        Your Answer (e.g., O(n), O(n¬≤), O(log n)):
                    </label>
                    <input 
                        type="text" 
                        id="answer-input" 
                        placeholder="Enter Big-O notation..."
                        class="w-full px-4 py-3 border-2 border-teal-300 rounded-lg focus:border-teal-500 focus:outline-none text-lg font-mono"
                        onkeypress="if(event.key === 'Enter') checkAnswer()"
                    >
                    <button 
                        onclick="checkAnswer()"
                        class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all"
                    >
                        Check Answer
                    </button>
                </div>

                <!-- Hint -->
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded mb-6">
                    <p class="text-sm text-yellow-800">
                        <strong>üí° Hint:</strong> <span id="hint-text"></span>
                    </p>
                </div>

                <!-- Feedback -->
                <div id="feedback" class="hidden"></div>
            </div>

            <!-- Start Message -->
            <div id="start-message" class="text-center py-12">
                <p class="text-xl text-gray-600 mb-4">Ready to practice Big-O notation?</p>
                <button 
                    onclick="generateProblem()"
                    class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-8 rounded-lg text-lg transition-all transform hover:scale-105"
                >
                    Generate First Problem
                </button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='scripts.js') }}"></script>
    <script>
        let currentProblem = null;

        async function generateProblem() {
            const difficulty = document.getElementById('difficulty').value;
            const problemType = document.getElementById('problem-type').value;

            try {
                const response = await fetch('/api/generate-big-o-problem', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        difficulty, 
                        type: problemType === 'both' ? 'both' : problemType
                    })
                });

                const problem = await response.json();
                currentProblem = problem;
                displayProblem(problem);
                document.getElementById('start-message').classList.add('hidden');
                document.getElementById('problem-container').classList.remove('hidden');
                document.getElementById('answer-input').value = '';
                document.getElementById('feedback').classList.add('hidden');
                
                // Focus on input if it exists
                const answerInput = document.getElementById('answer-input');
                if (answerInput && !answerInput.classList.contains('hidden')) {
                    answerInput.focus();
                }
            } catch (error) {
                alert('Error generating problem: ' + error.message);
            }

            updateStats();
        }

        function displayProblem(problem) {
            document.getElementById('question-text').textContent = problem.question;
            document.getElementById('hint-text').textContent = problem.hint;
            
            // Hide all display areas first
            document.getElementById('code-display').classList.add('hidden');
            document.getElementById('expression-display').classList.add('hidden');
            document.getElementById('options-display').classList.add('hidden');
            document.getElementById('answer-input-container').classList.add('hidden');
            
            if (problem.type === 'code_analysis' || problem.type === 'match') {
                // Show code
                document.getElementById('code-display').classList.remove('hidden');
                document.getElementById('code-text').textContent = problem.code;
                
                if (problem.type === 'match') {
                    // Show multiple choice options
                    if (problem.options && problem.options.length > 0) {
                        document.getElementById('options-display').classList.remove('hidden');
                        const optionsDiv = document.getElementById('options-display');
                        optionsDiv.innerHTML = '';
                        
                        problem.options.forEach((option, index) => {
                            if (option) {  // Only add non-empty options
                                const button = document.createElement('button');
                                button.className = 'bg-teal-100 hover:bg-teal-200 text-teal-800 font-bold py-3 px-4 rounded-lg transition-all border-2 border-teal-300';
                                button.textContent = option;
                                button.onclick = () => selectOption(option);
                                optionsDiv.appendChild(button);
                            }
                        });
                    } else {
                        // Fallback if no options
                        console.error('Match problem missing options');
                        document.getElementById('answer-input-container').classList.remove('hidden');
                    }
                } else {
                    // Show answer input for code_analysis
                    document.getElementById('answer-input-container').classList.remove('hidden');
                }
            } else if (problem.type === 'simplify') {
                // Show expression
                document.getElementById('expression-display').classList.remove('hidden');
                document.getElementById('expression-text').textContent = problem.expression;
                
                // Show answer input
                document.getElementById('answer-input-container').classList.remove('hidden');
            }
        }

        function selectOption(option) {
            // Clear previous selections
            document.querySelectorAll('#options-display button').forEach(btn => {
                btn.classList.remove('bg-teal-600', 'text-white');
                btn.classList.add('bg-teal-100', 'text-teal-800');
            });
            
            // Highlight selected option
            document.querySelectorAll('#options-display button').forEach(btn => {
                if (btn.textContent.trim() === option) {
                    btn.classList.remove('bg-teal-100', 'text-teal-800');
                    btn.classList.add('bg-teal-600', 'text-white');
                }
            });
            
            // Check answer immediately for match type
            setTimeout(() => {
                checkAnswer(option);
            }, 500);
        }

        async function checkAnswer(selectedOption = null) {
            if (!currentProblem) return;

            let userAnswer;
            if (currentProblem.type === 'match') {
                if (!selectedOption) {
                    // Try to find selected option
                    const selected = document.querySelector('#options-display button.bg-teal-600');
                    if (!selected) {
                        alert('Please select an option');
                        return;
                    }
                    userAnswer = selected.textContent.trim();
                } else {
                    userAnswer = selectedOption.trim();
                }
            } else {
                userAnswer = document.getElementById('answer-input').value.trim();
                if (!userAnswer) {
                    alert('Please enter an answer');
                    return;
                }
            }

            try {
                const response = await fetch('/api/check-big-o-answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        problem_type: currentProblem.type,
                        answer: userAnswer,
                        correct_answer: currentProblem.correct_answer
                    })
                });

                const result = await response.json();
                showFeedback(result);
                updateStats();
            } catch (error) {
                alert('Error checking answer: ' + error.message);
            }
        }

        function showFeedback(result) {
            const feedbackDiv = document.getElementById('feedback');
            feedbackDiv.classList.remove('hidden');

            // Escape HTML to prevent XSS
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            const explanation = currentProblem && currentProblem.explanation ? escapeHtml(currentProblem.explanation) : '';
            const correctAnswer = result.correct_answer ? escapeHtml(result.correct_answer) : 'N/A';
            const errorMsg = result.error ? escapeHtml(result.error) : '';

            if (result.correct) {
                feedbackDiv.className = 'bg-green-100 border-l-4 border-green-500 p-4 rounded mb-4';
                feedbackDiv.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="text-2xl">‚úÖ</span>
                        <div>
                            <p class="font-bold text-green-800">Correct!</p>
                            <p class="text-sm text-green-700">Great job! Your answer is right.</p>
                            ${explanation ? `<p class="text-sm text-green-700 mt-2"><strong>Explanation:</strong> ${explanation}</p>` : ''}
                        </div>
                    </div>
                    <button 
                        onclick="generateProblem()"
                        class="mt-3 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-all"
                    >
                        Next Problem ‚Üí
                    </button>
                `;
            } else {
                feedbackDiv.className = 'bg-red-100 border-l-4 border-red-500 p-4 rounded mb-4';
                feedbackDiv.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="text-2xl">‚ùå</span>
                        <div>
                            <p class="font-bold text-red-800">Incorrect</p>
                            ${errorMsg ? `<p class="text-sm text-red-700 mb-2"><strong>Error:</strong> ${errorMsg}</p>` : ''}
                            <p class="text-sm text-red-700">Correct answer: <code class="bg-red-200 px-2 py-1 rounded font-mono">${correctAnswer}</code></p>
                            ${explanation ? `<p class="text-sm text-red-700 mt-2"><strong>Explanation:</strong> ${explanation}</p>` : ''}
                        </div>
                    </div>
                    <button 
                        onclick="generateProblem()"
                        class="mt-3 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-all"
                    >
                        Try Another Problem ‚Üí
                    </button>
                `;
            }
        }

        async function updateStats() {
            try {
                const response = await fetch('/api/get-stats');
                const data = await response.json();
                
                document.getElementById('accuracy').textContent = data.accuracy + '%';
                document.getElementById('correct').textContent = data.stats.correct;
                document.getElementById('total').textContent = data.stats.total;
                document.getElementById('streak').textContent = data.stats.streak;
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        // Load stats on page load
        updateStats();
    </script>
</body>
</html>

